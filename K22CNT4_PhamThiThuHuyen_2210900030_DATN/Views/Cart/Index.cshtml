@model List<K22CNT4_PhamThiThuHuyen_2210900030_DATN.ViewModels.CartItemVM>

@{
    ViewData["Title"] = "Giỏ hàng";
    Layout = "~/Views/Shared/_LayoutCustomer.cshtml";
}
<style>
    .quantity-group {
        width: 110px;
    }

    .quantity-input {
        height: 30px;
        font-size: 13px;
        padding: 0;
    }

    .quantity-group .btn {
        width: 28px;
        height: 30px;
        padding: 0;
        font-size: 14px;
    }

</style>

<div class="container mt-5">

    <h2 class="mb-4">🛒 Giỏ hàng</h2>

    @if (!Model.Any())
    {
        <p>Giỏ hàng trống</p>
    }
    else
    {
        <!-- ===== XÓA TẤT CẢ  ===== -->
        <div class="d-flex justify-content-end mb-2">
            <form asp-controller="Cart"
                  asp-action="Clear"
                  method="post"
                  onsubmit="return confirm('Bạn có chắc muốn xóa toàn bộ giỏ hàng?');">
                <button class="btn btn-outline-danger btn-sm">
                    <i class="fa fa-trash me-1"></i> Xóa tất cả
                </button>
            </form>
        </div>

        <!-- ===== BẢNG GIỎ HÀNG ===== -->
        <table class="table align-middle">
            <thead>
                <tr>
                    <th>Ảnh</th>
                    <th>Sản phẩm</th>
                    <th>Giá</th>
                    <th>Số lượng</th>
                    <th>Tổng</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            <img src="@item.Image" width="60" />
                        </td>

                        <td>@item.Name <br/> @item.MoTa </td>

                        <td>@item.Price.ToString("N0") ₫</td>

                        <td>
                            <form asp-controller="Cart"
                                  asp-action="Update"
                                  method="post"
                                  class="d-flex align-items-center cart-update-form">

                                <input type="hidden" name="id" value="@item.ProductVariantId" />

                                <div class="input-group input-group-sm quantity-group">
                                    <button type="button" class="btn btn-outline-secondary btn-minus">−</button>

                                    <input type="number"
                                           name="quantity"
                                           value="@item.Quantity"
                                           min="1"
                                           class="form-control text-center quantity-input" />

                                    <button type="button" class="btn btn-outline-secondary btn-plus">+</button>
                                </div>
                            </form>
                        </td>


                        <td>@item.Total.ToString("N0") ₫</td>

                        <td>
                            <a asp-controller="Cart"
                               asp-action="Remove"
                               asp-route-id="@item.ProductVariantId"
                               class="btn btn-danger btn-sm">
                                Xóa
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- ===== TỔNG TIỀN + THANH TOÁN ===== -->
        <div class="d-flex justify-content-end align-items-center gap-3 mt-4">
            <h4 class="mb-0">
                Tổng tiền:
                <span class="text-danger">
                    @Model.Sum(x => x.Total).ToString("N0") ₫
                </span>
            </h4>
            <a asp-controller="Cart"
               asp-action="Checkout"
               class="btn btn-success px-4">
                Thanh toán
            </a>

        </div>
    }

</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        document.querySelectorAll('.cart-update-form').forEach(form => {

            const input = form.querySelector('.quantity-input');
            const btnMinus = form.querySelector('.btn-minus');
            const btnPlus = form.querySelector('.btn-plus');

            function submitForm() {
                form.submit();
            }

            btnMinus.onclick = () => {
                let val = parseInt(input.value);
                if (val > 1) {
                    input.value = val - 1;
                    submitForm();
                }
            };

            btnPlus.onclick = () => {
                let val = parseInt(input.value);
                input.value = val + 1;
                submitForm();
            };

            // nếu người dùng gõ tay rồi blur
            input.onchange = () => {
                if (parseInt(input.value) < 1) input.value = 1;
                submitForm();
            };
        });

    });
</script>

