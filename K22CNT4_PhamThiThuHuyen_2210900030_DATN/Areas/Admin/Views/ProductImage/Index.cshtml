@model List<K22CNT4_PhamThiThuHuyen_2210900030_DATN.Models.EF.ProductImage>

@{
    ViewBag.Title = "Ảnh sản phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<h2>Quản lý ảnh sản phẩm</h2>

<input type="hidden" id="productId" value="@ViewBag.ProductId" />

<!-- ===== FORM UPLOAD ===== -->
<div class="row mb-3">
    <div class="col-md-6">
        <input type="file" id="fileImage" class="form-control" />
    </div>
    <div class="col-md-2 d-flex align-items-center">
        <label class="mb-0">
            <input type="checkbox" id="ckDefault" /> Ảnh mặc định
        </label>
    </div>
    <div class="col-md-2">
        <button type="button" id="btnAdd" class="btn btn-success w-100">
            Thêm ảnh
        </button>
    </div>
</div>

<!-- ===== TABLE ===== -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Ảnh</th>
            <th>Mặc định</th>
            <th width="200">Thao tác</th>
        </tr>
    </thead>
    <tbody id="imageTable">
        @foreach (var item in Model)
        {
            <tr data-id="@item.ProductImagesid"
                class="@(item.Isdefault == 1 ? "table-success" : "")">
                <td>
                    <img src="@item.Urlimg" width="120" />
                </td>
                <td class="td-default">
                    @if (item.Isdefault == 1)
                    {
                        <span class="badge bg-success">Default</span>
                    }
                </td>
                <td>
                    <button class="btn btn-sm btn-primary btn-set-default"
                            @(item.Isdefault == 1 ? "disabled" : "")
                            data-id="@item.ProductImagesid">
                        Đặt mặc định
                    </button>

                    <button class="btn btn-sm btn-danger btn-delete"
                            data-id="@item.ProductImagesid">
                        Xóa
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

@section scripts {
    <script>
               // ================== ADD IMAGE ==================
        $('#btnAdd').click(function () {
            const productId = $('#productId').val();
            const file = $('#fileImage')[0].files[0];
            const isDefault = $('#ckDefault').is(':checked');

            if (!file) {
                alert('Vui lòng chọn ảnh');
                return;
            }

            const formData = new FormData();
            formData.append('productId', productId);
            formData.append('image', file);
            formData.append('isDefault', isDefault);

            $.ajax({
                url: '/Admin/ProductImage/Add',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (res) {
                    if (!res.success) {
                        alert('Thêm ảnh thất bại');
                        return;
                    }

                    // 🔥 QUAY VỀ TRANG QUẢN LÝ SẢN PHẨM
                    window.location.href = '/Admin/Product';
                }
            });
        });


        // ================== DELETE IMAGE ==================
        $(document).on('click', '.btn-delete', function () {
            if (!confirm('Xóa ảnh này?')) return;

            const btn = $(this);
            const id = btn.data('id');

            $.post('/Admin/ProductImage/Delete', { id: id }, function (res) {
                if (res.success) {
                    btn.closest('tr').fadeOut(300, function () {
                        $(this).remove();
                    });
                } else {
                    alert('Xóa thất bại');
                }
            });
        });

        // ================== SET DEFAULT ==================
        $(document).on('click', '.btn-set-default', function () {
            const btn = $(this);
            const id = btn.data('id');

            $.post('/Admin/ProductImage/SetDefault', { id: id }, function (res) {
                if (!res.success) {
                    alert('Không thể đặt mặc định');
                    return;
                }

                // Reset toàn bộ UI
                $('#imageTable tr').removeClass('table-success');
                $('#imageTable .td-default').html('');
                $('#imageTable .btn-set-default').prop('disabled', false);

                // Set UI cho ảnh mới
                const row = btn.closest('tr');
                row.addClass('table-success');
                row.find('.td-default').html('<span class="badge bg-success">Default</span>');
                btn.prop('disabled', true);
            });
        });
    </script>
}
